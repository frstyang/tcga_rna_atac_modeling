"""
Snakemake pipeline that is essentially a wrapper for apply_to_query.py. 
"""

import os

# ============================================================================
# Configuration (loaded from config file)
# ============================================================================

LOG_DIR = config.get("log_dir", "logs")
os.makedirs(LOG_DIR, exist_ok=True)

# Directories
CODE_DIR = config["code_dir"]
OUT_DIR = config["out_dir"]
PEAK_SET = config["peak_set"]
ATAC_C = config["atac_C"]
GENE_SET = config["gene_set"]
RNA_C = config["rna_C"]
RNA_DIR = config["rna_dir"]
ATAC_DIR = config["atac_dir"]
DEFAULT_C = config["default_C"]
EVEN_BARPLOT = config.get("even_barplot", True)

# Conda environments
SNAPATAC2_ENV = config["snapatac2_env"]

# ============================================================================
# Target rule
# ============================================================================

rule all:
    input:
        os.path.join(OUT_DIR, "apply_custom", "sorted_barplot_median_adjusted.png"),
        os.path.join(OUT_DIR, "apply_custom", "shap", "atac_shap_vals.csv"),
        os.path.join(OUT_DIR, "apply_custom", "shap", "atac_coefs.csv"),
        os.path.join(OUT_DIR, "apply_hv_small", "sorted_barplot_median_adjusted.png"),
        os.path.join(OUT_DIR, "apply_hv_small", "shap", "atac_shap_vals.csv"),
        os.path.join(OUT_DIR, "apply_hv_small", "shap", "atac_coefs.csv"),
        os.path.join(OUT_DIR, "apply_hv_med", "sorted_barplot_median_adjusted.png"),
        os.path.join(OUT_DIR, "apply_hv_med", "shap", "atac_shap_vals.csv"),
        os.path.join(OUT_DIR, "apply_hv_med", "shap", "atac_coefs.csv"),
        os.path.join(OUT_DIR, "apply_hv_large", "sorted_barplot_median_adjusted.png"),
        os.path.join(OUT_DIR, "apply_hv_large", "shap", "atac_shap_vals.csv"),
        os.path.join(OUT_DIR, "apply_hv_large", "shap", "atac_coefs.csv")

# ============================================================================
# Step 1.1: apply to query
# ============================================================================

rule apply_to_query_custom:
    input:
        atac_dir = ATAC_DIR,
        rna_dir = RNA_DIR, 
    output:
        barplot = os.path.join(OUT_DIR, "apply_custom", "sorted_barplot_median_adjusted.png"),
        shap_vals = os.path.join(OUT_DIR, "apply_custom", "shap", "atac_shap_vals.csv"),
        coefs = os.path.join(OUT_DIR, "apply_custom", "shap", "atac_coefs.csv")
    params:
        code_dir = CODE_DIR,
        out_dir = os.path.join(OUT_DIR, "apply_custom"),
        atac_C = ATAC_C,
        rna_C = RNA_C,
        peak_set = PEAK_SET,
        gene_set = GENE_SET,
        even_barplot_flag = "--even_barplot" if EVEN_BARPLOT else "",
    conda: SNAPATAC2_ENV
    threads: 6
    resources:
        mem_mb = 48000,
        runtime = 120,
    log:
        os.path.join(LOG_DIR, "apply_to_query.log")
    shell:
        """
        python -u {params.code_dir}/apply_to_query.py \
            {params.out_dir} \
            {input.atac_dir}/query_log2cpm.rds \
            {input.rna_dir}/query_log2cpm.rds \
            {input.atac_dir}/{params.peak_set} \
            {params.atac_C} \
            {input.rna_dir}/{params.gene_set} \
            {params.rna_C} \
            {params.even_barplot_flag} \
            2>&1 | tee {log}
        """

rule apply_to_query_hv_small:
    input:
        atac_dir = ATAC_DIR,
        rna_dir = RNA_DIR, 
    output:
        barplot = os.path.join(OUT_DIR, "apply_hv_small", "sorted_barplot_median_adjusted.png"),
        shap_vals = os.path.join(OUT_DIR, "apply_hv_small", "shap", "atac_shap_vals.csv"),
        coefs = os.path.join(OUT_DIR, "apply_hv_small", "shap", "atac_coefs.csv")
    params:
        code_dir = CODE_DIR,
        out_dir = os.path.join(OUT_DIR, "apply_hv_small"),
        atac_C = DEFAULT_C,
        rna_C = DEFAULT_C,
        peak_set = "hvp_5000",
        gene_set = "hvg_500",
        even_barplot_flag = "--even_barplot" if EVEN_BARPLOT else "",
    conda: SNAPATAC2_ENV
    threads: 6
    resources:
        mem_mb = 48000,
        runtime = 120,
    log:
        os.path.join(LOG_DIR, "apply_to_query.log")
    shell:
        """
        python -u {params.code_dir}/apply_to_query.py \
            {params.out_dir} \
            {input.atac_dir}/query_log2cpm.rds \
            {input.rna_dir}/query_log2cpm.rds \
            {input.atac_dir}/{params.peak_set} \
            {params.atac_C} \
            {input.rna_dir}/{params.gene_set} \
            {params.rna_C} \
            {params.even_barplot_flag} \
            2>&1 | tee {log}
        """

rule apply_to_query_hv_med:
    input:
        atac_dir = ATAC_DIR,
        rna_dir = RNA_DIR, 
    output:
        barplot = os.path.join(OUT_DIR, "apply_hv_med", "sorted_barplot_median_adjusted.png"),
        shap_vals = os.path.join(OUT_DIR, "apply_hv_med", "shap", "atac_shap_vals.csv"),
        coefs = os.path.join(OUT_DIR, "apply_hv_med", "shap", "atac_coefs.csv")
    params:
        code_dir = CODE_DIR,
        out_dir = os.path.join(OUT_DIR, "apply_hv_med"),
        atac_C = DEFAULT_C,
        rna_C = DEFAULT_C,
        peak_set = "hvp_10000",
        gene_set = "hvg_3000",
        even_barplot_flag = "--even_barplot" if EVEN_BARPLOT else "",
    conda: SNAPATAC2_ENV
    threads: 6
    resources:
        mem_mb = 48000,
        runtime = 120,
    log:
        os.path.join(LOG_DIR, "apply_to_query.log")
    shell:
        """
        python -u {params.code_dir}/apply_to_query.py \
            {params.out_dir} \
            {input.atac_dir}/query_log2cpm.rds \
            {input.rna_dir}/query_log2cpm.rds \
            {input.atac_dir}/{params.peak_set} \
            {params.atac_C} \
            {input.rna_dir}/{params.gene_set} \
            {params.rna_C} \
            {params.even_barplot_flag} \
            2>&1 | tee {log}
        """

rule apply_to_query_hv_large:
    input:
        atac_dir = ATAC_DIR,
        rna_dir = RNA_DIR, 
    output:
        barplot = os.path.join(OUT_DIR, "apply_hv_large", "sorted_barplot_median_adjusted.png"),
        shap_vals = os.path.join(OUT_DIR, "apply_hv_large", "shap", "atac_shap_vals.csv"),
        coefs = os.path.join(OUT_DIR, "apply_hv_large", "shap", "atac_coefs.csv")
    params:
        code_dir = CODE_DIR,
        out_dir = os.path.join(OUT_DIR, "apply_hv_large"),
        atac_C = DEFAULT_C,
        rna_C = DEFAULT_C,
        peak_set = "hvp_50000",
        gene_set = "hvg_5000",
        even_barplot_flag = "--even_barplot" if EVEN_BARPLOT else "",
    conda: SNAPATAC2_ENV
    threads: 6
    resources:
        mem_mb = 48000,
        runtime = 120,
    log:
        os.path.join(LOG_DIR, "apply_to_query.log")
    shell:
        """
        python -u {params.code_dir}/apply_to_query.py \
            {params.out_dir} \
            {input.atac_dir}/query_log2cpm.rds \
            {input.rna_dir}/query_log2cpm.rds \
            {input.atac_dir}/{params.peak_set} \
            {params.atac_C} \
            {input.rna_dir}/{params.gene_set} \
            {params.rna_C} \
            {params.even_barplot_flag} \
            2>&1 | tee {log}
        """
